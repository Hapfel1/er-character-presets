name: Process Preset Submission via PR

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create-pr-from-issue:
    if: contains(github.event.issue.labels.*.name, 'preset-submission')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pillow
      
      - name: Parse issue and extract data
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            console.log('Parsing issue #' + issue.number);
            
            // Extract data
            const nameMatch = body.match(/\*\*Preset Name:\*\*\s*(.+)/);
            const authorMatch = body.match(/\*\*Author:\*\*\s*(.+)/);
            const tagsMatch = body.match(/\*\*Tags:\*\*\s*(.+)/);
            const descMatch = body.match(/\*\*Description:\*\*\s*\n([\s\S]+?)\n\n---/);
            
            if (!nameMatch || !authorMatch || !tagsMatch || !descMatch) {
              throw new Error('Missing required fields');
            }
            
            const name = nameMatch[1].trim();
            const author = authorMatch[1].trim();
            const tags = tagsMatch[1].trim();
            const description = descMatch[1].trim();
            
            // Extract appearance JSON
            const jsonMatch = body.match(/```json\s*([\s\S]+?)\s*```/);
            if (!jsonMatch) {
              throw new Error('No appearance JSON found');
            }
            
            const appearance = JSON.parse(jsonMatch[1]);
            
            core.setOutput('preset_name', name);
            core.setOutput('author', author);
            core.setOutput('tags', tags);
            core.setOutput('description', description);
            core.setOutput('appearance', JSON.stringify(appearance));
            
            console.log(`Extracted: ${name} by ${author}`);
      
      - name: Download images from ZIP
        id: download_images
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const https = require('https');
            const { execSync } = require('child_process');
            
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // Find ZIP file attachment
            // GitHub attaches files as: [filename.zip](https://github.com/...)
            const zipRegex = /\[([^\]]+\.zip)\]\((https:\/\/[^)]+)\)/gi;
            const zipMatches = [...body.matchAll(zipRegex)];
            
            console.log(`Found ${zipMatches.length} ZIP files`);
            
            let hasImages = false;
            
            if (zipMatches.length > 0) {
              // Download first ZIP file
              const zipUrl = zipMatches[0][2];
              const zipFilename = 'preset_images.zip';
              
              console.log(`Downloading ZIP from: ${zipUrl}`);
              
              await new Promise((resolve, reject) => {
                https.get(zipUrl, (response) => {
                  if (response.statusCode === 302 || response.statusCode === 301) {
                    https.get(response.headers.location, (redirectResponse) => {
                      const file = fs.createWriteStream(zipFilename);
                      redirectResponse.pipe(file);
                      file.on('finish', () => {
                        file.close();
                        resolve();
                      });
                      file.on('error', reject);
                    }).on('error', reject);
                  } else {
                    const file = fs.createWriteStream(zipFilename);
                    response.pipe(file);
                    file.on('finish', () => {
                      file.close();
                      resolve();
                    });
                    file.on('error', reject);
                  }
                }).on('error', reject);
              });
              
              // Extract ZIP
              console.log('Extracting ZIP...');
              execSync(`unzip -o ${zipFilename}`);
              
              // Check for extracted images
              const hasFace = fs.existsSync('face.png') || fs.existsSync('face.jpg') || fs.existsSync('face.jpeg');
              const hasBody = fs.existsSync('body.png') || fs.existsSync('body.jpg') || fs.existsSync('body.jpeg');
              const hasPreview = fs.existsSync('preview.png') || fs.existsSync('preview.jpg') || fs.existsSync('preview.jpeg');
              
              console.log(`Extracted images - Face: ${hasFace}, Body: ${hasBody}, Preview: ${hasPreview}`);
              
              hasImages = hasFace || hasBody;
              
              core.setOutput('has_face', hasFace ? 'true' : 'false');
              core.setOutput('has_body', hasBody ? 'true' : 'false');
              core.setOutput('has_preview', hasPreview ? 'true' : 'false');
              core.setOutput('has_images', hasImages ? 'true' : 'false');
            } else {
              core.setOutput('has_images', 'false');
            }
      
      - name: Generate preset ID
        id: generate_id
        run: |
          # Find highest preset number
          HIGHEST=0
          if [ -f index.json ]; then
            HIGHEST=$(jq -r '.presets[].id' index.json | grep -oP 'preset_\K\d+' | sort -n | tail -1)
            if [ -z "$HIGHEST" ]; then
              HIGHEST=0
            fi
          fi
          
          NEXT=$((HIGHEST + 1))
          PRESET_ID=$(printf "preset_%03d" $NEXT)
          
          echo "preset_id=$PRESET_ID" >> $GITHUB_OUTPUT
          echo "Generated ID: $PRESET_ID"
      
      - name: Create preset files in subfolder
        run: |
          PRESET_ID="${{ steps.generate_id.outputs.preset_id }}"
          PRESET_NAME="${{ steps.parse.outputs.preset_name }}"
          AUTHOR="${{ steps.parse.outputs.author }}"
          TAGS="${{ steps.parse.outputs.tags }}"
          DESCRIPTION="${{ steps.parse.outputs.description }}"
          APPEARANCE='${{ steps.parse.outputs.appearance }}'
          
          # Create preset subfolder
          mkdir -p "presets/${PRESET_ID}"
          
          # Save appearance JSON
          TAGS_ARRAY=$(echo "$TAGS" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          CREATED_DATE=$(date +%Y-%m-%d)
          
          jq -n \
            --arg id "$PRESET_ID" \
            --arg name "$PRESET_NAME" \
            --arg author "$AUTHOR" \
            --arg description "$DESCRIPTION" \
            --argjson tags "$TAGS_ARRAY" \
            --argjson appearance "$APPEARANCE" \
            --arg created "$CREATED_DATE" \
            '{
              id: $id,
              name: $name,
              author: $author,
              description: $description,
              tags: $tags,
              appearance: $appearance,
              created: $created
            }' > "presets/${PRESET_ID}/data.json"
          
          # Copy images to subfolder
          HAS_FACE="${{ steps.download_images.outputs.has_face }}"
          HAS_BODY="${{ steps.download_images.outputs.has_body }}"
          HAS_PREVIEW="${{ steps.download_images.outputs.has_preview }}"
          
          # Face image (required)
          if [ "$HAS_FACE" = "true" ]; then
            for ext in png jpg jpeg; do
              if [ -f "face.$ext" ]; then
                cp "face.$ext" "presets/${PRESET_ID}/face.png"
                # Use face as preview if no preview provided
                if [ "$HAS_PREVIEW" != "true" ]; then
                  cp "face.$ext" "presets/${PRESET_ID}/preview.png"
                fi
                break
              fi
            done
          fi
          
          # Body image (required)
          if [ "$HAS_BODY" = "true" ]; then
            for ext in png jpg jpeg; do
              if [ -f "body.$ext" ]; then
                cp "body.$ext" "presets/${PRESET_ID}/body.png"
                # Use body as fallback if no face and no preview
                if [ "$HAS_FACE" != "true" ] && [ "$HAS_PREVIEW" != "true" ]; then
                  cp "body.$ext" "presets/${PRESET_ID}/preview.png"
                fi
                break
              fi
            done
          fi
          
          # Preview image (optional - overrides face/body)
          if [ "$HAS_PREVIEW" = "true" ]; then
            for ext in png jpg jpeg; do
              if [ -f "preview.$ext" ]; then
                cp "preview.$ext" "presets/${PRESET_ID}/preview.png"
                break
              fi
            done
          fi
          
          # CLEANUP: Remove extracted files and ZIP
          rm -f face.png face.jpg face.jpeg
          rm -f body.png body.jpg body.jpeg
          rm -f preview.png preview.jpg preview.jpeg
          rm -f preset_images.zip *.zip
          
          echo "Created preset files in presets/${PRESET_ID}/"
          ls -la "presets/${PRESET_ID}/"
      
      - name: Update index.json
        run: |
          PRESET_ID="${{ steps.generate_id.outputs.preset_id }}"
          PRESET_NAME="${{ steps.parse.outputs.preset_name }}"
          AUTHOR="${{ steps.parse.outputs.author }}"
          TAGS="${{ steps.parse.outputs.tags }}"
          DESCRIPTION="${{ steps.parse.outputs.description }}"
          HAS_FACE="${{ steps.download_images.outputs.has_face }}"
          HAS_BODY="${{ steps.download_images.outputs.has_body }}"
          HAS_PREVIEW="${{ steps.download_images.outputs.has_preview }}"
          
          if [ ! -f index.json ]; then
            cat > index.json << 'EOF'
          {
            "version": "1.0.0",
            "last_updated": "",
            "base_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/",
            "presets": []
          }
          EOF
          fi
          
          TAGS_ARRAY=$(echo "$TAGS" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          CREATED_DATE=$(date +%Y-%m-%d)
          UPDATED_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # Build index entry with URLs
          INDEX_ENTRY=$(jq -n \
            --arg id "$PRESET_ID" \
            --arg name "$PRESET_NAME" \
            --arg author "$AUTHOR" \
            --arg description "$DESCRIPTION" \
            --argjson tags "$TAGS_ARRAY" \
            --arg data_url "presets/${PRESET_ID}/data.json" \
            --arg screenshot_url "presets/${PRESET_ID}/preview.png" \
            --arg face_url "presets/${PRESET_ID}/face.png" \
            --arg body_url "presets/${PRESET_ID}/body.png" \
            --arg preview_url "presets/${PRESET_ID}/preview.png" \
            --arg created "$CREATED_DATE" \
            --arg has_face "$HAS_FACE" \
            --arg has_body "$HAS_BODY" \
            --arg has_preview "$HAS_PREVIEW" \
            '{
              id: $id,
              name: $name,
              author: $author,
              description: $description,
              tags: $tags,
              data_url: $data_url,
              screenshot_url: $screenshot_url,
              created: $created
            } + 
            (if $has_face == "true" then {face_url: $face_url} else {} end) +
            (if $has_body == "true" then {body_url: $body_url} else {} end) +
            (if $has_preview == "true" then {preview_url: $preview_url} else {} end)'
          )
          
          # Update index.json
          jq --argjson entry "$INDEX_ENTRY" \
             --arg updated "$UPDATED_TIME" \
             '.presets += [$entry] | .last_updated = $updated' \
             index.json > index.json.tmp
          mv index.json.tmp index.json
          
          echo "Updated index.json with preset $PRESET_ID"
      
      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add preset: ${{ steps.parse.outputs.preset_name }}"
          branch: preset-${{ steps.generate_id.outputs.preset_id }}
          title: "New Preset: ${{ steps.parse.outputs.preset_name }}"
          body: |
            ## Preset Submission
            
            **Name:** ${{ steps.parse.outputs.preset_name }}
            **Author:** ${{ steps.parse.outputs.author }}
            **Tags:** ${{ steps.parse.outputs.tags }}
            
            **Description:**
            ${{ steps.parse.outputs.description }}
            
            **Preset ID:** ${{ steps.generate_id.outputs.preset_id }}
            
            ---
            
            Submitted via issue #${{ github.event.issue.number }}
            
            **Files added:**
            - `presets/${{ steps.generate_id.outputs.preset_id }}/data.json`
            - `presets/${{ steps.generate_id.outputs.preset_id }}/face.png`
            - `presets/${{ steps.generate_id.outputs.preset_id }}/body.png`
            - `presets/${{ steps.generate_id.outputs.preset_id }}/preview.png`
            - Updated `index.json`
            
            **Review checklist:**
            - [ ] Preset data is valid
            - [ ] Images look appropriate
            - [ ] No inappropriate content
            - [ ] Author credited correctly
          labels: preset-submission,automated-pr
      
      - name: Comment on issue with PR link
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `✅ Pull request created: #${prNumber}\n\nYour preset will be reviewed by a maintainer and added to the database once approved!`
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: ['pr-created']
              });
            }
        env:
          PR_NUMBER: ${{ steps.create_pr.outputs.pull-request-number }}
      
      - name: Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `❌ Failed to process submission. Please check the workflow logs:\n\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['processing-failed']
            });
            