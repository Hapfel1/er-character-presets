name: Process Preset Submission via PR

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create-pr-from-issue:
    # Only process issues with preset-submission label
    if: contains(github.event.issue.labels.*.name, 'preset-submission')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pillow
      
      - name: Parse issue and extract data
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            console.log('Parsing issue #' + issue.number);
            
            // Extract data from issue body
            const nameMatch = body.match(/\*\*Preset Name:\*\*\s*(.+)/);
            const authorMatch = body.match(/\*\*Author:\*\*\s*(.+)/);
            const tagsMatch = body.match(/\*\*Tags:\*\*\s*(.+)/);
            const descMatch = body.match(/\*\*Description:\*\*\s*\n([\s\S]+?)\n\n---/);
            
            if (!nameMatch || !authorMatch || !tagsMatch || !descMatch) {
              console.error('Missing required fields');
              throw new Error('Missing required fields in issue body');
            }
            
            const presetName = nameMatch[1].trim();
            const author = authorMatch[1].trim();
            const tags = tagsMatch[1].trim();
            const description = descMatch[1].trim();
            
            console.log('Extracted:', {presetName, author, tags});
            
            // Extract appearance JSON
            const jsonMatch = body.match(/```json\s*\n([\s\S]+?)\n```/);
            if (!jsonMatch) {
              throw new Error('Missing appearance JSON');
            }
            
            const appearance = JSON.parse(jsonMatch[1]);
            
            // Set outputs
            core.setOutput('preset_name', presetName);
            core.setOutput('author', author);
            core.setOutput('tags', tags);
            core.setOutput('description', description);
            core.setOutput('appearance_json', JSON.stringify(appearance));
            core.setOutput('issue_number', issue.number);
            
            return { presetName, author, tags, description };
      
      - name: Generate preset ID
        id: generate_id
        run: |
          echo "Generating next preset ID..."
          
          if [ -f index.json ]; then
            LAST_ID=$(jq -r '.presets[-1].id // "preset_000"' index.json)
            echo "Last preset ID: $LAST_ID"
            
            NUM=$(echo $LAST_ID | sed 's/preset_0*//')
            NEXT_NUM=$((NUM + 1))
            PRESET_ID=$(printf "preset_%03d" $NEXT_NUM)
          else
            echo "No index.json found, starting with preset_001"
            PRESET_ID="preset_001"
          fi
          
          echo "Generated preset ID: $PRESET_ID"
          echo "preset_id=$PRESET_ID" >> $GITHUB_OUTPUT
      
      - name: Download images from issue
        id: download_images
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const fs = require('fs');
            const https = require('https');
            
            // Find images in issue body
            const body = issue.body || '';
            const imageRegex = /!\[([^\]]*)\]\((https:\/\/[^)]+)\)/g;
            const images = [...body.matchAll(imageRegex)];
            
            console.log(`Found ${images.length} images in issue body`);
            
            // Map image labels to filenames
            const imageMap = {
              'face': null,
              'body': null,
              'preview': null
            };
            
            for (const match of images) {
              const altText = match[1].toLowerCase();
              const url = match[2];
              
              console.log(`Processing image: ${altText} from ${url}`);
              
              // Determine image type from alt text
              let imageType = null;
              if (altText.includes('face')) {
                imageType = 'face';
              } else if (altText.includes('body')) {
                imageType = 'body';
              } else if (altText.includes('preview')) {
                imageType = 'preview';
              }
              
              if (imageType && !imageMap[imageType]) {
                // Download image
                const ext = url.match(/\.(png|jpg|jpeg|gif)(\?|$)/i)?.[1] || 'png';
                const filename = `${imageType}.${ext}`;
                
                await new Promise((resolve, reject) => {
                  https.get(url, (response) => {
                    if (response.statusCode === 302 || response.statusCode === 301) {
                      // Follow redirect
                      https.get(response.headers.location, (redirectResponse) => {
                        const file = fs.createWriteStream(filename);
                        redirectResponse.pipe(file);
                        file.on('finish', () => {
                          file.close();
                          console.log(`Downloaded ${imageType} as ${filename}`);
                          resolve();
                        });
                        file.on('error', reject);
                      }).on('error', reject);
                    } else {
                      const file = fs.createWriteStream(filename);
                      response.pipe(file);
                      file.on('finish', () => {
                        file.close();
                        console.log(`Downloaded ${imageType} as ${filename}`);
                        resolve();
                      });
                      file.on('error', reject);
                    }
                  }).on('error', reject);
                });
                
                imageMap[imageType] = filename;
              }
            }
            
            // Check if we have at least face or body
            const hasImages = imageMap.face || imageMap.body;
            console.log('Image map:', imageMap);
            
            core.setOutput('has_face', imageMap.face ? 'true' : 'false');
            core.setOutput('has_body', imageMap.body ? 'true' : 'false');
            core.setOutput('has_preview', imageMap.preview ? 'true' : 'false');
            core.setOutput('has_images', hasImages ? 'true' : 'false');
      
      - name: Create preset files
        run: |
          PRESET_ID="${{ steps.generate_id.outputs.preset_id }}"
          PRESET_NAME="${{ steps.parse.outputs.preset_name }}"
          AUTHOR="${{ steps.parse.outputs.author }}"
          TAGS="${{ steps.parse.outputs.tags }}"
          DESCRIPTION="${{ steps.parse.outputs.description }}"
          APPEARANCE='${{ steps.parse.outputs.appearance_json }}'
          
          echo "Creating preset files for $PRESET_ID..."
          
          mkdir -p presets
          
          # Create preset JSON
          TAGS_ARRAY=$(echo "$TAGS" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          CREATED_DATE=$(date +%Y-%m-%d)
          
          jq -n \
            --arg id "$PRESET_ID" \
            --arg name "$PRESET_NAME" \
            --arg author "$AUTHOR" \
            --arg description "$DESCRIPTION" \
            --argjson tags "$TAGS_ARRAY" \
            --argjson appearance "$APPEARANCE" \
            --arg screenshot "presets/${PRESET_ID}.png" \
            --arg created "$CREATED_DATE" \
            '{
              id: $id,
              name: $name,
              author: $author,
              description: $description,
              tags: $tags,
              appearance: $appearance,
              screenshot_url: $screenshot,
              downloads: 0,
              created: $created
            }' > presets/${PRESET_ID}.json
          
          echo "Created presets/${PRESET_ID}.json"
          
          # Copy images with preset ID naming
          HAS_FACE="${{ steps.download_images.outputs.has_face }}"
          HAS_BODY="${{ steps.download_images.outputs.has_body }}"
          HAS_PREVIEW="${{ steps.download_images.outputs.has_preview }}"
          
          if [ "$HAS_FACE" = "true" ]; then
            for ext in png jpg jpeg gif; do
              if [ -f "face.$ext" ]; then
                cp "face.$ext" "presets/${PRESET_ID}_face.png"
                # Also use as main screenshot
                cp "face.$ext" "presets/${PRESET_ID}.png"
                echo "Copied face image"
                break
              fi
            done
          fi
          
          if [ "$HAS_BODY" = "true" ]; then
            for ext in png jpg jpeg gif; do
              if [ -f "body.$ext" ]; then
                cp "body.$ext" "presets/${PRESET_ID}_body.png"
                # If no face, use body as main screenshot
                if [ "$HAS_FACE" != "true" ]; then
                  cp "body.$ext" "presets/${PRESET_ID}.png"
                fi
                echo "Copied body image"
                break
              fi
            done
          fi
          
          if [ "$HAS_PREVIEW" = "true" ]; then
            for ext in png jpg jpeg gif; do
              if [ -f "preview.$ext" ]; then
                cp "preview.$ext" "presets/${PRESET_ID}_preview.png"
                echo "Copied preview image"
                break
              fi
            done
          fi
          
          echo "Preset files created successfully"
          ls -lh presets/${PRESET_ID}*
      
      - name: Update index.json
        run: |
          PRESET_ID="${{ steps.generate_id.outputs.preset_id }}"
          PRESET_NAME="${{ steps.parse.outputs.preset_name }}"
          AUTHOR="${{ steps.parse.outputs.author }}"
          TAGS="${{ steps.parse.outputs.tags }}"
          DESCRIPTION="${{ steps.parse.outputs.description }}"
          
          echo "Updating index.json..."
          
          if [ ! -f index.json ]; then
            echo "Creating new index.json"
            cat > index.json << 'INDEXEOF'
          {
            "version": "1.0.0",
            "last_updated": "",
            "base_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/",
            "presets": []
          }
          INDEXEOF
          fi
          
          TAGS_ARRAY=$(echo "$TAGS" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          CREATED_DATE=$(date +%Y-%m-%d)
          UPDATED_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          INDEX_ENTRY=$(jq -n \
            --arg id "$PRESET_ID" \
            --arg name "$PRESET_NAME" \
            --arg author "$AUTHOR" \
            --arg description "$DESCRIPTION" \
            --argjson tags "$TAGS_ARRAY" \
            --arg data_url "presets/${PRESET_ID}.json" \
            --arg screenshot_url "presets/${PRESET_ID}.png" \
            --arg created "$CREATED_DATE" \
            '{
              id: $id,
              name: $name,
              author: $author,
              description: $description,
              tags: $tags,
              data_url: $data_url,
              screenshot_url: $screenshot_url,
              downloads: 0,
              created: $created
            }')
          
          jq --argjson entry "$INDEX_ENTRY" \
             --arg updated "$UPDATED_TIME" \
             '.presets += [$entry] | .last_updated = $updated' \
             index.json > index.tmp && mv index.tmp index.json
          
          echo "index.json updated successfully"
      
      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add preset: ${{ steps.parse.outputs.preset_name }} by ${{ steps.parse.outputs.author }}"
          branch: preset-${{ steps.generate_id.outputs.preset_id }}
          delete-branch: true
          title: "[Preset] ${{ steps.parse.outputs.preset_name }} by ${{ steps.parse.outputs.author }}"
          body: |
            ## Preset Submission from Issue #${{ steps.parse.outputs.issue_number }}
            
            **Preset ID:** `${{ steps.generate_id.outputs.preset_id }}`
            **Name:** ${{ steps.parse.outputs.preset_name }}
            **Author:** ${{ steps.parse.outputs.author }}
            **Tags:** ${{ steps.parse.outputs.tags }}
            
            **Description:**
            ${{ steps.parse.outputs.description }}
            
            ---
            
            ### Files Added:
            - `presets/${{ steps.generate_id.outputs.preset_id }}.json` - Preset data
            - `presets/${{ steps.generate_id.outputs.preset_id }}.png` - Main screenshot
            - `presets/${{ steps.generate_id.outputs.preset_id }}_face.png` - Face screenshot (if provided)
            - `presets/${{ steps.generate_id.outputs.preset_id }}_body.png` - Body screenshot (if provided)
            - Updated `index.json`
            
            ---
            
            **Review this PR and merge to add the preset to the database.**
            
            Original issue: #${{ steps.parse.outputs.issue_number }}
          labels: preset-submission
      
      - name: Comment on issue with PR link
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.create_pr.outputs.pull-request-number }}';
            const prUrl = '${{ steps.create_pr.outputs.pull-request-url }}';
            const presetId = '${{ steps.generate_id.outputs.preset_id }}';
            
            if (prNumber && prUrl) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.parse.outputs.issue_number }},
                body: `## ‚úÖ Preset Processing Complete!\n\n` +
                      `Your preset has been processed and a Pull Request has been created.\n\n` +
                      `**Preset ID:** \`${presetId}\`\n` +
                      `**Pull Request:** #${prNumber}\n` +
                      `**Link:** ${prUrl}\n\n` +
                      `The maintainer will review and merge the PR to add your preset to the database.\n\n` +
                      `Thank you for contributing! üéâ`
              });
              
              // Add label to indicate PR created
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.parse.outputs.issue_number }},
                labels: ['pr-created']
              });
            }
      
      - name: Handle errors
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `## ‚ùå Automated Processing Failed\n\n` +
                    `There was an error processing your submission.\n\n` +
                    `**Error details:** Check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.\n\n` +
                    `The maintainer has been notified and will process your submission manually.\n\n` +
                    `Common issues:\n` +
                    `- Missing or invalid appearance JSON\n` +
                    `- Images not properly attached\n` +
                    `- Formatting errors in issue body`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['processing-failed']
            });